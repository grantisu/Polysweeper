<!DOCTYPE html>
<html>
<head>
  <title>Trisweeper</title>
  <meta charset="UTF-8">
<style>

body {
	text-align: center;
}

#theboard {
	border: 1px dashed black;
	margin: auto;
}

#theboard svg {
	max-width: 60em;
	max-height: 50em;
}

</style>

<script>

/* globals, yay */
var svgns = "http://www.w3.org/2000/svg";
var start;
var rows;
var cols;
var bombTotal;
var bombMarked;
var revealed;
var mOffset;
var sbTime;
var sbScore;
var msvg;
var sInt;

/* ghetto style */
var p_unclicked = 'fill:gray;stroke:#000;stroke-width:0.05;stroke-linejoin:bevel;';
var p_clicked   = 'fill:white;fill-opacity:0;stroke:#000;stroke-width:0.01;stroke-linejoin:bevel;';
var p_flagged   = 'fill:yellow;stroke:#000;stroke-width:0.05;stroke-linejoin:bevel;';
var p_maybe     = 'fill:orange;stroke:#000;stroke-width:0.05;stroke-linejoin:bevel;';
var p_bomb      = 'fill:red;stroke:#000;stroke-width:0.05;stroke-linejoin:bevel;';
var t_clicked   = 'font-size:0.4px;font-weight:bold;text-anchor:middle;';
var r_color = {
	1: '#229',
	2: '#282',
	3: '#762',
	4: '#922',
	5: '#600',
	6: '#626',
	7: '#146',
	8: '#243',
	9: '#222',
};

function get_node(row, col) {
	if (row >= 0 && col >= 0 && row < rows && col < cols) {
		var idx = mOffset + row*cols + col;
		return msvg.childNodes[idx];
	} else {
		return undefined;
	}
}

function update_time() {
	var dur = Math.floor((Date.now() - start) / 1000);
	sbTime.textContent = 'Time ' + dur;
}

function update_score() {
	sbScore.textContent = 'UXB ' + (bombTotal - bombMarked);
}

function update_size(ev) {
	var mH = 0.80*window.innerHeight;
	document.getElementById('theboard').firstChild.style.maxHeight = mH+'px';
}

function end_game() {
	clearInterval(sInt);
	sInt = undefined;
	msvg.onclick = undefined;
	msvg.oncontextmenu = undefined;
}

function brd_click(ev) {
	var el = ev.target;

	if (ev.button == 0) {
		click_helper(el);
	} else if (el.clickable && ev.button == 2) {
		if (el.flagged) {
			el.flagged = false;
			el.setAttribute('style', p_unclicked);
			bombMarked -= 1;
		} else {
			el.flagged = true;
			el.setAttribute('style', p_flagged);
			bombMarked += 1;
		}
	} else if (!el.clickable && ev.button == 2 && el.count) {
		reveal_around(el.row, el.col);
	}

	update_score();

	return false;
}

function click_helper(el) {
	if (!(el && (el.clickable && !el.flagged))) { return; }
	el.clickable = false;

	var row = el.row;
	var col = el.col;
	el.setAttribute('style', p_clicked);

	if (el.bomb) {
		el.setAttribute('style', p_bomb);
		if (sInt) { end_game(); }
		for (var j = 0; j < cols; j++) {
		for (var i = 0; i < rows; i++) {
			click_helper(get_node(i, j));
		}
		}
		return false;
	}
	
	if (el.count) {
		var p = el.parentNode;
		var t = document.createElementNS(svgns, 'text');
		var c = 
		t.setAttribute('x', col*0.5 + 0.5);
		t.setAttribute('y', row + 0.8 - 0.3*((row+col) & 1));
		t.setAttribute('style', t_clicked + 'fill:' + r_color[el.count]+';');
		t.textContent = el.count;
		/* make sure text appears beneath everything */
		p.insertBefore(t, p.firstChild);
		mOffset += 1;
	} else {
		reveal_around(row, col);
	}

	if (sInt && ++revealed == (rows*cols - bombTotal)) {
		var dur = Date.now() - start;
		end_game();
		alert("Winnar!\n"+(0.001*dur).toFixed(2)+" secs");
	}
}

function reveal_around(row, col) {
	if ((row+col) & 1) {
		/* pointing down */
		click_helper(get_node(row + 1, col - 1));
		click_helper(get_node(row + 1, col    ));
		click_helper(get_node(row + 1, col + 1));

		click_helper(get_node(row    , col - 2));
		click_helper(get_node(row    , col - 1));
		click_helper(get_node(row    , col + 1));
		click_helper(get_node(row    , col + 2));

		click_helper(get_node(row - 1, col - 2));
		click_helper(get_node(row - 1, col - 1));
		click_helper(get_node(row - 1, col    ));
		click_helper(get_node(row - 1, col + 1));
		click_helper(get_node(row - 1, col + 2));
	} else {
		/* pointing up */
		click_helper(get_node(row - 1, col - 1));
		click_helper(get_node(row - 1, col    ));
		click_helper(get_node(row - 1, col + 1));

		click_helper(get_node(row    , col - 2));
		click_helper(get_node(row    , col - 1));
		click_helper(get_node(row    , col + 1));
		click_helper(get_node(row    , col + 2));

		click_helper(get_node(row + 1, col - 2));
		click_helper(get_node(row + 1, col - 1));
		click_helper(get_node(row + 1, col    ));
		click_helper(get_node(row + 1, col + 1));
		click_helper(get_node(row + 1, col + 2));
	}
}

function new_tri(row, col) {
	var pstr;
	var xo = 0.5*col;
	var yo = row + 0.05;

	if ((row + col) & 1) {
		pstr = (xo+0.0)+','+(yo+0.0)+' '+(xo+1.0)+','+(yo+0.0)+' '+(xo+0.5)+','+(yo+1.0);
	} else {
		pstr = (xo+0.0)+','+(yo+1.0)+' '+(xo+0.5)+','+(yo+0.0)+' '+(xo+1.0)+','+(yo+1.0);
	}

	var p = document.createElementNS(svgns, 'polygon');
	p.setAttribute('points', pstr);
	p.setAttribute('style', p_unclicked);
	p.clickable = true;
	p.bomb = 0;
	p.row = row;
	p.col = col;

	return p;
}

function bomb_helper(row, col) {
	var n = get_node(row, col)
	if (n && n.bomb) {
		return 1;
	} else {
		return 0;
	}
}

function build_board() {

	if (sInt) { clearInterval(sInt); } 

	rows = parseInt(document.getElementById('rowCount').value);
	cols = parseInt(document.getElementById('colCount').value);
	bombTotal = parseInt(document.getElementById('bombCount').value);

	if (isNaN(rows) || rows < 1 || rows > 100) {
		alert("Bad row count: "+rows);
		return;
	}

	if (isNaN(cols) || cols < 1 || cols > 100) {
		alert("Bad col count: "+cols);
		return;
	}

	if (isNaN(bombTotal) || rows * cols < 2 * bombTotal) {
		alert("Too many bombs!");
		return;
	}

	bombMarked = 0;
	revealed = 0;
	mOffset = 0;

	var brd = document.getElementById('theboard');
	sbTime = document.getElementById('thetime');
	sbScore = document.getElementById('thescore');
	brd.innerHTML = '';
	sbTime.innerHTML = '';
	sbScore.innerHTML = '';
	msvg = document.createElementNS(svgns, 'svg');

	msvg.setAttribute('version', '1.1');
	msvg.setAttribute('viewBox', '0 0 ' + 0.5*(cols+1) + ' ' + (rows+0.1));

	/* build SVG base */
	for (var i = 0; i < rows; i++) {
		for (var j = 0; j < cols; j++) {
			msvg.appendChild(new_tri(i, j));
		}
	}

	/* set up the bombs */
	for (var b = 0; b < bombTotal; b++) {
		var row, col;
		var n = {bomb: true};
		while (n.bomb) {
			row = Math.floor(Math.random()*rows);
			col = Math.floor(Math.random()*cols);
			n = get_node(row, col);
		}
		n.bomb = 1;
	}

	/* mark all the nodes */
	for (var i = 0; i < rows; i++) {
	for (var j = 0; j < cols; j++) {
		var n = get_node(i, j);
		if (n.bomb) { continue; }

		if ((i+j) & 1) {
			/* pointing down */
			n.count = 0
			+ bomb_helper(i + 1, j - 1)
			+ bomb_helper(i + 1, j    )
			+ bomb_helper(i + 1, j + 1)

			+ bomb_helper(i    , j - 2)
			+ bomb_helper(i    , j - 1)
			+ bomb_helper(i    , j + 1)
			+ bomb_helper(i    , j + 2)

			+ bomb_helper(i - 1, j - 2)
			+ bomb_helper(i - 1, j - 1)
			+ bomb_helper(i - 1, j    )
			+ bomb_helper(i - 1, j + 1)
			+ bomb_helper(i - 1, j + 2);
		} else {
			/* pointing up */
			n.count = 0
			+ bomb_helper(i - 1, j - 1)
			+ bomb_helper(i - 1, j    )
			+ bomb_helper(i - 1, j + 1)

			+ bomb_helper(i    , j - 2)
			+ bomb_helper(i    , j - 1)
			+ bomb_helper(i    , j + 1)
			+ bomb_helper(i    , j + 2)

			+ bomb_helper(i + 1, j - 2)
			+ bomb_helper(i + 1, j - 1)
			+ bomb_helper(i + 1, j    )
			+ bomb_helper(i + 1, j + 1)
			+ bomb_helper(i + 1, j + 2);
		}
	}
	}

	document.getElementById('thebutton').textContent = 'Restart';
	window.onresize = update_size;
	msvg.onclick = brd_click;
	msvg.oncontextmenu = function(ev){ return brd_click(ev); };

	brd.appendChild(msvg);
	start = Date.now();
	update_size();
	update_score();
	update_time();
	sInt = setInterval(update_time, 500);

}

</script>
</head>
<body onload='build_board()'>

<h1>Trisweeper</h1>

<div id='thetime'></div>
<div id='thescore'></div>
<div id='theboard'></div>
<label for='bombCount'>Bombs</label>
<input type='text' name='bombCount' id='bombCount' value=49>
<label for='rowCount'>Rows</label>
<input type='text' name='rowCount' id='rowCount' value=16>
<label for='colCount'>Cols</label>
<input type='text' name='colCount' id='colCount' value=30>
<button id='thebutton' type='button' onclick='build_board()'>Start</button>

</body>
</html>
